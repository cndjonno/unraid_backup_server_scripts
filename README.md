# Unraid Backup & Failover Server Scripts

**Automated backup, sync, and failover solution for two Unraid servers.**

This repository contains a set of Bash scripts designed to be used with the **Unraid User Scripts Plugin**. They automate the process of waking up a backup server, syncing data and appdata from a main (source) server, and optionally spinning up containers on the backup server to act as a failover.

## üåü Features

* **Auto-Wake Backup Server**: Automatically powers on the destination server using Wake-on-LAN (WOL) before starting the backup.
* **Data & Appdata Sync**: Uses `rsync` to synchronize selected shares and Docker appdata folders.
* **Failover Capability ("Switch Server")**: Can shut down the source server and automatically start specific Docker containers on the backup server (e.g., Plex/Emby/Jellyfin), preserving watch history and metadata.
* **Failback Capability ("Switch Back")**: Automates syncing data back to the main server and restoring the original state.
* **Power Management**: Options to shut down the backup server after syncing to save electricity and hardware lifespan.

---

## üìã Prerequisites

1.  **Two Unraid Servers**: A "Source" (Main) server and a "Destination" (Backup) server.
2.  **User Scripts Plugin**: Installed on both servers (available via Community Applications).
3.  **SSH Key Authentication**: The destination server **must** be able to SSH into the source server without a password. [See instructions below](#-ssh-key-setup-required).
4.  **Wake-on-LAN (WOL)**: The destination server must have WOL enabled in its BIOS and Unraid network settings if you want it to auto-boot.

---

## üìÇ Script Overview & Installation

There are 3 scripts in this suite. You will need to create a new script entry in the **User Scripts Plugin** for each one and paste the contents of the `.sh` files from this repo.

### 1. Source Server Backup Script (`source server backup script.sh`)
* **Location**: Run on the **Source (Main)** server.
* **Function**: This is the "Master" script. It handles the logic for waking the backup server, creating the config file, and initiating the sync.
* **Configuration**:
    * **All primary variables are set here.**
    * Edit the variables at the top of the file to define:
        * IP addresses (Source & Destination).
        * MAC address of the Destination (for WOL).
        * List of Shares to backup.
        * List of Docker Containers to backup/failover.
* **Schedule**: Set this to run on a custom Cron schedule (e.g., nightly at 3 AM).

### 2. Destination Server Backup Script (`destination server backup script.sh`)
* **Location**: Run on the **Destination (Backup)** server.
* **Function**: Performs the actual `rsync` pull command.
* **Configuration**:
    * **Only one variable needs editing**: `source_server_ip` (Set this to your Main server's IP).
* **Schedule**: Set to **"At Startup of Array"**.
    * *Note: It checks a flag file created by the source script. If the server was turned on manually, this script will exit without doing anything.*

### 3. Start Source Server Script (`start source server - destination server script.sh`)
* **Location**: Run on the **Destination (Backup)** server.
* **Function**: Used for the **"Switch Back"** scenario. It wakes the main server and syncs the latest data back to it.
* **Configuration**: No variables need to be set (it uses the config generated by the main script).
* **Schedule**: Set manually or scheduled only when you are ready to revert to the main server.

---

## üîë SSH Key Setup (Required)

For the scripts to work, the **Destination** server needs to communicate with the **Source** server securely without user intervention.

1.  **Open a Terminal** on the **Destination (Backup)** server.
2.  **Generate a key pair** (press Enter to accept defaults and **no passphrase**):
    ```bash
    ssh-keygen -t rsa -b 4096
    ```
3.  **Copy the key to the Source server**:
    * Replace `root` with your user (usually root on Unraid) and `SOURCE_IP` with the Main server's IP.
    ```bash
    ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.1.X
    ```
4.  **Test the connection**:
    * From the Destination terminal, type: `ssh root@192.168.1.X`
    * If you log in without being asked for a password, it works!

---

## üöÄ Usage Modes

Once configured, the system operates based on the settings you choose in the **Source Server Script**.

### Mode 1: Backup Only
* **Behavior**: Source wakes Backup -> Syncs Data -> Backup shuts down.
* **Use Case**: Nightly off-site or local backups to save power.

### Mode 2: Switch Server (Failover)
* **Behavior**: Source wakes Backup -> Syncs Data -> Source shuts down -> Backup starts specific Docker containers.
* **Use Case**: Moving operations to the backup server during maintenance or scheduled downtime.

### Mode 3: Switch Server Back (Restore)
* **Behavior**: Run the *Start Source Server* script on the Backup unit.
* **Action**: Backup wakes Source -> Syncs new data back to Source -> Backup stops containers -> Source starts containers -> Backup shuts down.
* **Use Case**: Returning to normal operations after a failover event.

---

## ‚ö†Ô∏è Important Notes

* **Network**: Ensure both servers have static IP addresses defined in your router or Unraid network settings.
* **First Run**: The first backup will take a significant amount of time as it must transfer all data. Subsequent runs will be fast (incremental).
* **Testing**: ALWAYS test with a test share/folder before automating critical data backups.

## ü§ù Credits
Original concept and scripts by [SpaceinvaderOne](https://github.com/SpaceinvaderOne).
Forked and maintained by [cndjonno](https://github.com/cndjonno).